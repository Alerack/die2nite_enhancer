<!DOCTYPE HTML>
<html>
  <head>
    <script type="application/javascript">

      // Wait for a network request to perform
      safari.application.addEventListener('message', function(event) {
        if (event.name !== 'do_network_request') {
          return;
        }

        param = event.message;

        event.target.page.dispatchMessage('log', param);

        var xmlhttp = new XMLHttpRequest();
        //xmlhttp.setDisableHeaderCheck(true); // mandatory as cookie are set
        xmlhttp.open(param.method, param.url, true);
        for (var header in param.headers) {
          xmlhttp.setRequestHeader(header, param.headers[header]);
        }
        xmlhttp.onreadystatechange = function() {
          if (xmlhttp.readyState === 4) {
            if (xmlhttp.status >= 200 && xmlhttp.status < 300) {
              return event.target.page.dispatchMessage('network_request_succeed',
                                                       xmlhttp.responseText);
            }
            return event.target.page.dispatchMessage('network_request_failed');
          }
        };
        xmlhttp.send(param.data);
      }, false);

    </script>
  </head>
  <body>
  </body>
</html>
